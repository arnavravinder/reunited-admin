<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Reunited</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared.css">
    <style>
        .approval-container { background-color: var(--light-bg); border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .approval-container h2 { border-bottom: 1px solid var(--dark-bg); padding-bottom: 15px; margin-top: 0; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; border: none; }
        .btn-approve { background-color: var(--success); color: white; }
        .btn-deny { background-color: var(--danger); color: white; margin-left: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background-color: var(--light-bg); padding: 25px; border-radius: 10px; text-align: center; border-left: 5px solid var(--accent-color); }
        .stat-card i { font-size: 2rem; color: var(--accent-color); margin-bottom: 15px; }
        .stat-card h3 { margin: 0; font-size: 2.5rem; }
        .stat-card p { margin: 5px 0 0; color: var(--text-secondary); }
        .category-stats .category-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--dark-bg); }
        .category-stats .category-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="adminApp">
        <header>
            <a href="index.html" class="logo">Reunited Admin</a>
            <nav class="nav-menu" id="nav-menu">
                <a href="index.html" class="active">Dashboard</a>
                <a href="add_item.html">Add Item</a>
                <a href="item_log.html">Item Log</a>
                <a href="daily_report.html">Claim Report</a>
                <a href="user_management.html">User Management</a>
                <a href="#" id="logout-link">Logout</a>
            </nav>
            <div class="hamburger" id="hamburger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </header>

        <main class="container">
            <h1>Dashboard</h1>

            <div v-if="isLoading" class="loading-spinner"><div class="spinner"></div></div>

            <div v-else>
                <section class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-box-open"></i>
                        <h3>{{ stats.totalFound }}</h3>
                        <p>Total Items Found (Unclaimed)</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-search"></i>
                        <h3>{{ stats.totalLost }}</h3>
                        <p>Total Items Reported Lost</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3>{{ stats.totalClaimed }}</h3>
                        <p>Total Items Claimed</p>
                    </div>
                    <div class="stat-card category-stats">
                        <i class="fas fa-tags"></i>
                        <p style="margin-bottom: 15px; font-weight: bold;">Items by Category</p>
                        <div v-if="Object.keys(stats.byCategory).length > 0">
                            <div v-for="(count, category) in stats.byCategory" :key="category" class="category-item">
                                <span>{{ category }}</span>
                                <strong>{{ count }}</strong>
                            </div>
                        </div>
                        <p v-else>No items found.</p>
                    </div>
                </section>

                <section class="approval-container">
                    <h2>Items Pending Approval ({{ pendingItems.length }})</h2>
                    <div v-if="pendingItems.length > 0" class="table-container">
                        <table>
                            <thead><tr><th>Name</th><th>Category</th><th>Location</th><th>Reported By</th><th>Actions</th></tr></thead>
                            <tbody>
                                <tr v-for="item in pendingItems" :key="item.id">
                                    <td>{{ item.name }}</td><td>{{ item.category }}</td><td>{{ item.location }}</td><td>{{ item.reportedByName }}</td>
                                    <td>
                                        <button class="btn-sm btn-approve" @click="approveItem(item)">Approve</button>
                                        <button class="btn-sm btn-deny" @click="denyItem(item)">Deny</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-else class="no-items"><p>No items are currently pending approval.</p></div>
                </section>

            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script>
        const db = firebase.firestore();

        const app = Vue.createApp({
            data() {
                return {
                    isLoading: true,
                    stats: { totalFound: 0, totalLost: 0, totalClaimed: 0, byCategory: {} },
                    pendingItems: [],
                };
            },
            async mounted() {
                await this.initializeDashboard();
            },
            methods: {
                async initializeDashboard() {
                    this.isLoading = true;
                    try {
                        const [foundItemsSnap, lostItemsSnap, pendingItemsSnap] = await Promise.all([
                            db.collection('items').get(),
                            db.collection('lostItems').where('status', '==', 'active').get(),
                            db.collection('items').where('status', '==', 'pending_approval').get()
                        ]);
                        
                        this.pendingItems = pendingItemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.processStats(foundItemsSnap, lostItemsSnap);

                    } catch(error) {
                        console.error("Error initializing dashboard:", error);
                        alert("Failed to load dashboard data. Please check the console.");
                    } finally {
                        this.isLoading = false;
                    }
                },
                processStats(foundItemsSnap, lostItemsSnap) {
                    const byCategory = {};
                    let totalFound = 0;
                    let totalClaimed = 0;

                    foundItemsSnap.forEach(doc => {
                        const item = doc.data();
                        if (item.status === 'available' && !item.claimed) {
                           totalFound++;
                           byCategory[item.category] = (byCategory[item.category] || 0) + 1;
                        } else if(item.claimed) {
                            totalClaimed++;
                        }
                    });
                    this.stats = { totalFound, totalClaimed, totalLost: lostItemsSnap.size, byCategory };
                },
                async approveItem(item) {
                    try {
                        await db.collection('items').doc(item.id).update({ status: 'available' });
                        await db.collection('notifications').add({
                            userId: item.reportedBy,
                            title: 'Your Found Item Report was Approved!',
                            message: `Your report for "${item.name}" has been approved and is now visible on the public search page.`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            type: 'item_approved', read: false, actionable: true,
                            itemType: 'found', itemId: item.id
                        });
                        this.pendingItems = this.pendingItems.filter(p => p.id !== item.id);
                        this.stats.totalFound++;
                    } catch(e) { console.error("Error approving item:", e); alert("Failed to approve item."); }
                },
                async denyItem(item) {
                    if (!confirm(`Are you sure you want to deny and delete the report for "${item.name}"?`)) return;
                    try {
                        await db.collection('items').doc(item.id).delete();
                         await db.collection('notifications').add({
                            userId: item.reportedBy,
                            title: 'Your Found Item Report was Rejected',
                            message: `Your report for "${item.name}" was rejected by an administrator. This may be due to insufficient detail or violation of our terms.`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            type: 'item_rejected', read: false, actionable: false
                        });
                        this.pendingItems = this.pendingItems.filter(p => p.id !== item.id);
                    } catch(e) { console.error("Error denying item:", e); alert("Failed to deny item."); }
                }
            }
        }).mount('#adminApp');
    </script>
</body>
</html>