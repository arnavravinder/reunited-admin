<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Tools - Reunited</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared.css">
    <style>
        .management-container { 
            background-color: var(--light-bg); 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 30px; 
        }
        .management-container h2 { 
            border-bottom: 1px solid var(--dark-bg); 
            padding-bottom: 15px; 
            margin-top: 0; 
        }
        .bulk-tool { 
            background-color: var(--dark-bg); 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .btn { 
            padding: 10px 20px; 
            font-size: 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            border: none; 
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { 
            background-color: var(--accent-color); 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: var(--accent-color-dark); 
        }
        .btn-success { 
            background-color: var(--success); 
            color: white; 
            margin-right: 10px;
        }
        .btn-danger { 
            background-color: var(--danger); 
            color: white; 
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .suggestions-list {
            margin-top: 20px;
        }
        .suggestion-item {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-content {
            flex-grow: 1;
        }
        .original-name {
            color: var(--text-secondary);
            text-decoration: line-through;
        }
        .suggested-name {
            color: var(--accent-color);
            font-weight: 500;
            margin-top: 5px;
        }
        .suggestion-actions {
            display: flex;
            gap: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--dark-bg);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            transition: width 0.3s;
        }
        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
        }
        .status-info {
            background-color: rgba(110, 127, 255, 0.1);
            color: var(--accent-color);
        }
        .status-success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        .status-error {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div id="managementApp">
        <header>
            <a href="index.html" class="logo">Reunited Admin</a>
            <nav class="nav-menu" id="nav-menu">
                <a href="index.html">Dashboard</a>
                <a href="add_item.html">Add Item</a>
                <a href="item_log.html">Item Log</a>
                <a href="daily_report.html">Claim Report</a>
                <a href="user_management.html">User Management</a>
                <a href="lost_items.html">Lost Items</a>
                <a href="management.html" class="active">Management</a>
                <a href="#" id="logout-link">Logout</a>
            </nav>
            <div class="hamburger" id="hamburger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </header>

        <main class="container">
            <h1>Management Tools</h1>

            <div class="management-container">
                <h2>AI Hoodie Auto-Fix</h2>
                <div class="bulk-tool">
                    <p>Automatically find "AI hoodie" items and replace with "IA hoodie" + size. Changes are applied immediately, but you can review and revert if needed.</p>
                    
                    <button class="btn btn-primary" @click="startAutoFix" :disabled="isProcessing">
                        <i class="fas fa-magic"></i> Auto-Fix AI Hoodies
                    </button>

                    <div v-if="isProcessing" class="progress-bar">
                        <div class="progress-fill" :style="{width: progressPercent + '%'}"></div>
                    </div>

                    <div v-if="statusMessage" class="status-message" :class="statusClass">
                        {{ statusMessage }}
                    </div>

                    <div v-if="appliedChanges.length > 0" class="suggestions-list">
                        <h3>Applied Changes ({{ appliedChanges.length }})</h3>
                        <div v-for="change in appliedChanges" :key="change.id" class="suggestion-item">
                            <div class="suggestion-content">
                                <div class="original-name">{{ change.originalName }}</div>
                                <div class="suggested-name">{{ change.newName }}</div>
                            </div>
                            <div class="suggestion-actions">
                                <button class="btn btn-danger" @click="revertChange(change)" :disabled="change.reverted">
                                    <i class="fas fa-undo"></i> {{ change.reverted ? 'Reverted' : 'Revert' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script>
        const db = firebase.firestore();

        const app = Vue.createApp({
            data() {
                return {
                    isProcessing: false,
                    appliedChanges: [],
                    statusMessage: '',
                    statusClass: '',
                    processedCount: 0,
                    totalCount: 0
                };
            },
            computed: {
                progressPercent() {
                    return this.totalCount > 0 ? (this.processedCount / this.totalCount) * 100 : 0;
                }
            },
            methods: {
                async startAutoFix() {
                    if (!confirm('This will automatically find and fix "AI hoodie" items by replacing with "IA hoodie" + size. Continue?')) {
                        return;
                    }

                    this.isProcessing = true;
                    this.appliedChanges = [];
                    this.statusMessage = 'Searching for AI hoodie items...';
                    this.statusClass = 'status-info';
                    this.processedCount = 0;

                    try {
                        const snapshot = await db.collection('items').where('status', '==', 'available').get();
                        const items = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).filter(item => item.name.toLowerCase().includes('ai hoodie'));

                        this.totalCount = items.length;
                        this.statusMessage = `Found ${items.length} AI hoodie items. Processing...`;

                        if (items.length === 0) {
                            this.statusMessage = 'No AI hoodie items found.';
                            this.statusClass = 'status-info';
                            this.isProcessing = false;
                            return;
                        }

                        const promises = items.map(async (item) => {
                            try {
                                const newName = await this.getImprovedHoodieName(item.name);
                                
                                if (newName && newName !== item.name) {
                                    // Apply the change immediately
                                    await db.collection('items').doc(item.id).update({
                                        name: newName
                                    });
                                    
                                    this.processedCount++;
                                    this.statusMessage = `Fixed ${this.processedCount} of ${items.length} items...`;
                                    
                                    return {
                                        id: item.id,
                                        originalName: item.name,
                                        newName: newName,
                                        reverted: false
                                    };
                                }
                                
                                this.processedCount++;
                                return null;
                                
                            } catch (error) {
                                console.error(`Error processing item ${item.name}:`, error);
                                this.processedCount++;
                                return null;
                            }
                        });
                        
                        const results = await Promise.all(promises);
                        this.appliedChanges = results.filter(result => result !== null);

                        this.statusMessage = `Auto-fix complete! Applied ${this.appliedChanges.length} changes.`;
                        this.statusClass = 'status-success';
                        
                    } catch (error) {
                        console.error('Error in auto-fix:', error);
                        this.statusMessage = 'Error occurred during processing. Please try again.';
                        this.statusClass = 'status-error';
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async getImprovedHoodieName(itemName) {
                    const prompt = `Convert this item name to the format: "IA hoodie jacket — size (X)" where X is the existing size.

Current name: "${itemName}"

Rules:
1. Always use format: "IA hoodie jacket — size (X)"
2. Extract any existing size from the original name (numbers, letters like S/M/L/XL, etc.)
3. If no size exists in original, use "IA hoodie jacket — size (unknown)"
4. Use em dash (—) before "size"
5. Put size in parentheses

Examples:
- "AI hoodie size 12" → "IA hoodie jacket — size (12)"
- "AI hoodie XL" → "IA hoodie jacket — size (XL)"  
- "AI hoodie" → "IA hoodie jacket — size (unknown)"

Only return the improved name, nothing else.`;

                    try {
                        const response = await fetch('https://ai.hackclub.com/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                messages: [
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ],
                                model: 'openai/gpt-oss-120b'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        return data.choices[0].message.content.trim();
                        
                    } catch (error) {
                        console.error('AI API Error:', error);
                        return null;
                    }
                },

                async revertChange(change) {
                    if (!confirm(`Revert "${change.newName}" back to "${change.originalName}"?`)) {
                        return;
                    }
                    
                    try {
                        await db.collection('items').doc(change.id).update({
                            name: change.originalName
                        });
                        
                        change.reverted = true;
                        
                        this.statusMessage = `Successfully reverted "${change.newName}" back to "${change.originalName}"`;
                        this.statusClass = 'status-success';
                        
                    } catch (error) {
                        console.error('Error reverting item:', error);
                        this.statusMessage = 'Error reverting item. Please try again.';
                        this.statusClass = 'status-error';
                    }
                }
            }
        }).mount('#managementApp');
    </script>
</body>
</html>